---
title: "Using Logistic Regression to Determine if Maternal Smoking Behavior has an Associative Effect with Odds of Preterm Births"
author: "John Owusu Duah"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---
```{r setup, include=FALSE}
options(warn = -1)
options(xtable.comment = FALSE)
options(tinytex.verbose = TRUE)
library(xtable)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
library(ggplot2)
library(MASS)
library(arm)
library(pROC)
library(e1071)
library(caret)
library(rms) #for VIF
library(MASS)
require(gridExtra)

knitr::opts_chunk$set(fig.width=10, fig.height=5)
```

## Summary

The objectives of this analysis are to examine if maternal smoking behavior has an associative effect with the odds of pre-term births, determine the likely range for the odds ratio of preterm birth for mothers who smoke versus mothers who do not smoke and determine if the interaction between smoking behavior and mother's race is statistically significant. We started by performing Exploratory Data Analysis (EDA) to gain an intuition into the predictor variables we needed to select in our baseline model, after which we performed stepwise model selection with AIC to see if it would generate a model that would be more optimum than our baseline model. At the end of the stepwise model selection process, the selected model had approximately the same predictor variables as the baseline model except interactions. Also, the selected model had approximately the same accuracy, sensitivity, specificity and AUC as the baseline model. For both models, we performed model diagnostics and validation. Ultimately, we selected the model generated by the stepwise model selection with AIC because it was more interpretable and since the interactions were not statistically significant, our decision was justified. 

Our results showed us that for mothers who had the same pre-pregnancy weight, had less than 8th grade education and were white, the odds of giving birth to premature babies is 34% higher for mothers who smoke compared to mothers who do not smoke. We also found out that, accounting for all other predictors, we are 95% confident that the odds ratio of pre-term births for mothers who smoke lies between 7% less and 92% more than the odds ratio for mothers who do not smoke. After carrying out a Chi-squared test between our final model and a copy of the final model with the interaction between smoking habits of mothers and mother's race included, we had a p-value of 0.269. This means that the model with interaction between mother's smoking habits and mothers race is not significantly different from our final model, statistically. Thus, there is no statistically significant evidence that the odds ratio of pre-term births for smokers and non-smokers differ by mother's race.




## Introduction

Fifty years ago it was not trite knowledge that pregnant women could expose their unborn children to untold harm by smoking. The Child Health and Development Studies carried out a thorough study of babies born at the Kaiser Foundational Hospital in Oakland, California between 1960 and 1967. The smoking habits, along with socioeconomic, biographic and demographic conditions of the respondents were recorded and collated in a data set, which is the source of our statistical analysis. 

We would like to determine if there is association between odds of giving birth to premature babies and maternal smoking behavior. We would also like to find out the likely range for the odds ratio of pre-term birth for mothers who smoke versus mothers who do not smoke. Thirdly, we would also investigate if race significantly affects the association between smoking and odds of giving birth to premature babies.And finally, we will explore other interesting associations with the odds of pre-term birth that are note worthy.




## Data

Our data set was the clean version of the original data set called "smoking.csv". Our response variable, which is the gestational period of babies was converted into a binary categorical variable with 270 days being the critical threshold, before a logistic regression analysis was carried out. The continuous predictor variables in data set were centered from the get-go to preemptively handle multicollinearity which logistic regression models are sensitive to. We plotted box plots for the continuous predictor variables in our data set against our response variable to gain intuition about the relationships. We noticed that there was little difference in the distribution of mothers age for both preterm and non-preterm babies. The median age of mothers who gave birth to preterm babies was lower than the median age of mothers who gave birth to full term babies. Although the median height of mothers who gave birth to both premature and full term babies were approximately the same, the distribution of ages was marginally wider for mothers who gave birth to full term babies. Nevertheless, no associative pattern was observed. Mother's pre-pregnancy weight was selected as a potential predictor variable because the median pre-pregnancy weight of mothers who gave birth to preterm babies appeared significantly lower than the pre-pregnancy weight of mothers who give birth to full term babies. 

For categorical predictor variables, we explored joint conditional probabilities with the response variable and also carried out a Chi-squared test to determine if the two categorical variables were dependent. For the smoke predictor variable, we noticed that the probability of giving birth to premature babies was higher (ie.22%) for smokers than the probability of giving birth to premature babies (ie.17%) for non-smokers. However, the Chi-squared test yielded a p-value of 0.0694 which meant that the two categorical variables were independent. Nevertheless, because the inferential questions were centered around the smoking habits of mothers, we included it in our model. The total number of previous pregnancies (ie.parity) is a discrete variable and to have an idea of the distribution its values, we used a  contingency table rather than a box plot to explore its relationship. The contingency table revealed lack of data for total number of previous pregnancies that were larger than 4. If left unfixed, this would have produced binned residual plots that would be difficult to interpret. To solve this, we placed mothers who had four or more previous pregnancies into a category labeled 4, all the while making no changes to the other factors.. The p-value of a Chi-squared test between gestation and total number of previous pregnancies revealed independence. Thus, parity was not considered when carrying out model building. The Chi-squared test between gestation and mother's race revealed that the two variables were dependent. So we included mother's race in our model. The conditional probability matrix of mothers education revealed a telling trend. That is, the higher the educational level of a mother, the lower the probability that she would give birth to a preterm baby. Also, the p-value showed that these two variables are dependent on some level. The p-value of a Chi-squared test between gestation and family yearly income revealed independence. Thus, family yearly income was not considered when carrying out model building.

```{r, results='asis'}
babies <- read.csv("~/Desktop/IDS 702 Model Representation of Data Reading Material/assignment_data/smoking.csv", stringsAsFactor = FALSE, header = TRUE)
# convert race, gestation and education to factors
babies$mrace[(babies$mrace >= 0) & (babies$mrace <= 5)] <- 0
babies$gestation[(babies$gestation < 270)] <- 1
babies$gestation[(babies$gestation >= 270)] <- 0
babies$med[(babies$med == 7)] <- 6
babies$mrace <- factor(babies$mrace)
babies$gestation <- factor(babies$gestation)
babies$med <- factor(babies$med)
babies$inc <- factor(babies$inc)
babies$smoke <- factor(babies$smoke)
babies$gestation_condition <- factor(babies$gestation, levels=c(0,1),labels=c("Not Preterm","Preterm"))
babies$mage_c <- c(scale(babies$mage, scale=F))
babies$mht_c <- c(scale(babies$mht, scale=F))
babies$mpregwt_c <- c(scale(babies$mpregwt, scale=F))
str(babies)
```

```{r, results='asis'}
ggplot(babies,aes(x=gestation_condition, y=mage, fill=gestation_condition)) + geom_boxplot() + labs(title="Mothers Age vs Gestation", x="Was Baby Preterm?", y="Mothers Age") + theme_classic()
```

```{r, results='asis'}
#ggplot(babies,aes(x=gestation_condition, y=mht, fill=gestation_condition)) + geom_boxplot() + labs(title="Mothers Height vs Gestation", x="Was Baby Preterm?", y="Mother's Height") + theme_classic()
```

```{r, results='asis', echo=FALSE}
#ggplot(babies,aes(x=gestation_condition, y=mpregwt, fill=gestation_condition)) + geom_boxplot() + labs(title="Mothers Pre-pregnancy Weight vs Gestation", x="Was Baby Preterm?", y="Mothers Pre-pregnancy Weight") + theme_classic()
```

```{r, results='asis'}
tapply(babies$gestation_condition, babies$smoke, function(x) table(x)/sum(table(x)))
chisq.test(table(babies[,c("gestation_condition","smoke")]))
```

```{r, results='asis', echo=FALSE}
#table(babies[,c("gestation_condition","parity")])
```

```{r, results='asis', echo=FALSE}
#babies$parity[(babies$parity > 3)] <- 4
#babies$parity <- factor(babies$parity)
#table(babies[,c("gestation_condition","parity")])
```

```{r, results='asis', echo=FALSE}
#tapply(babies$gestation_condition, babies$parity, function(x) table(x)/sum(table(x)))
#chisq.test(table(babies[,c("gestation_condition","parity")]))
```

```{r, results='asis'}
tapply(babies$gestation_condition, babies$mrace, function(x) table(x)/sum(table(x)))
chisq.test(table(babies[,c("gestation_condition","mrace")]))
```

```{r, results='asis', echo=FALSE}
#tapply(babies$gestation_condition, babies$med, function(x) table(x)/sum(table(x)))
#chisq.test(table(babies[,c("gestation_condition","med")]))
```

```{r, results='asis', echo=FALSE}
#tapply(babies$gestation_condition, babies$inc, function(x) table(x)/sum(table(x)))
#chisq.test(table(babies[,c("gestation_condition","inc")]))
```

```{r, results='asis', echo=FALSE}
#table(babies[,c("gestation_condition", "smoke", "med")])
#table(babies[,c("gestation_condition", "smoke", "med")])/sum(table(babies[,c("gestation_condition", "smoke", "med")]))
#apply(table(babies[,c("gestation_condition", "smoke", "med")])/sum(table(babies[,c("gestation_condition", "smoke", "med")])),3, function(x) x/sum(x))
```


```{r, results='asis'}
ggplot(babies,aes(x=gestation, y=mpregwt_c, fill=gestation)) + geom_boxplot() + labs(title="Mothers Pre-pregnancy Weight vs Gestation, by Smoke", x="Gestation",y="Mothers Pre-pregnancy Weight") +theme_classic() + facet_wrap( ~ smoke) + scale_fill_discrete(labels=c("Full Term","Premature"))
```


After exploring interactions, we observed some noticeable interaction between mothers pre-pregnancy weight and smoking habits, as can be observed in the chart above, so we included the interaction in our baseline model. At the end of EDA, we identified the following predictor variables as being likely to have some associative relationship with whether a baby would be born premature or full term; mothers pre-pregnancy weight(mpregwt), smoking habits of mothers(smoke), mothers race(mrace), mothers education(med) and the interaction between mothers pre-pregnancy weight(mpregwt) and smoking habits of mothers(smoke).

It is worthy to note that all variables that were not selected as predictor variables in our baseline model were selected in the full model when we carried out the step wise model selection process as a check to see if we made the right decisions during the EDA.

```{r, results='asis', echo=FALSE}
#ggplot(babies,aes(x=gestation, y=mpregwt_c, fill=gestation)) + geom_boxplot() + labs(title="Mothers Race vs Gestation, by Mothers Race", x="Gestation",y="Mothers Pre-pregnancy Weight") +theme_classic() + facet_wrap( ~ mrace) + scale_fill_discrete(labels=c("Full Term","Premature"))
```

```{r, results='asis', echo=FALSE}
#ggplot(babies,aes(x=gestation, y=mpregwt_c, fill=gestation)) + geom_boxplot() + labs(title="Mothers Race vs Gestation, by Mothers Education", x="Gestation",y="Mothers Pre-pregnancy Weight") +theme_classic() + facet_wrap( ~ med) + scale_fill_discrete(labels=c("Full Term","Premature"))
```

```{r, results='asis', echo=FALSE}
#ggplot(babies,aes(x=gestation, y=mpregwt_c, fill=gestation)) + geom_boxplot() + labs(title="Mothers Race vs Gestation, by No. of Previous Pregnancies", x="Gestation",y="Mothers Pre-pregnancy Weight") +theme_classic() + facet_wrap( ~ parity) + scale_fill_discrete(labels=c("Full Term","Premature"))
```

## Model

We first built a baseline model with the predictor variables we identified from our EDA.

```{r, results='asis'}
baseline_model <- glm(gestation ~ smoke + mpregwt_c + mrace + med + mpregwt_c:smoke, family=binomial(link=logit),data=babies)
#summary(baseline_model)
xtable(baseline_model)
```

The equation of the baseline model is as follows:

$y_{i}|x_{i} ~ Bernoulli(\pi_{i}); log(\frac{\pi_{i}}{1-\pi_{i}}) = \beta _{0} + \beta _{1}x_{i1}(mpregwt)+ \beta _{2j}x_{i2}(mrace)+ \beta _{3j}x_{i3}(med)+ \beta _{4j}x_{i4}(smoke)+\beta _{4j}x_{i1}x_{i4}(mpregwt:smoke)$

where $\pi_{i}$ is the odds of giving birth to a premature baby

In diagnosing our baseline model, we first made binned residual plots vs the fitted values of the entire baseline model. The points appeared randomly distributed and all but one observation was outside the 95% confidence interval. We also made binned plots of average residuals versus our only continuous predictor variable of mothers pre-pregnancy weight. There was randomness in the points and all but two observations were located in the 95% confidence interval. These two observations were too close to the the 95% confidence interval to be considered outliers.

```{r, results='asis'}
rawresid1 <- residuals(baseline_model,"resp")
binnedplot(x=fitted(baseline_model), y=rawresid1, xlab="Pred. probabilities", col.int = "red4", ylab="Avg. residuals", main="Binned Residual Plot of Baseline Model", col.pts="navy")
```

```{r, results='asis'}
binnedplot(x=babies$mpregwt_c, y=rawresid1, xlab="Mothers Pre-pregnancy Weight Centered", col.int = "red4", ylab="Avg. residuals", main="Binned Residual Plot of Mothers Pre-pregnancy Weight", col.pts="navy")
```

```{r, results='asis'}
# We use response if we want predict probabilities on the scale of our data. If we want to predict probabilities on the logit scale we use link
babies$predprobs <- predict(baseline_model, type="response")
```


We validated our baseline model initially with a threshold probability of 0.5. Logistic regression models that can be relied upon to make good predictions have high sensitivity (ie.how well the model is predicting positive results), high specificity (ie.how well the model is predicting negative results) and AUC close to 1. With a sensitivity value of 0.02, our baseline model did not perform well when predicting the chances of mothers giving birth to premature babies. On the other hand with a specificity of 0.99, our baseline model performed well when predicting the chances of mothers giving birth to full-term babies.

We plotted ROC curve to visualize the accuracy of our data. We optimized for the best threshold and we had a threshold probability of 0.22, which raised the sensitivity of the  baseline model from 0.02 to 0.47 and decreased specificity from 0.99 to 0.77. Also, optimizing our model with a threshold of 0.22 reduced our accuracy from 0.81 to 0.71. And the AUC was 0.66. Since we did not observe any pattern in the binned residual plots, we could not justify carrying out transformation of our predictor variables to improve model performance. Instead, we sought to improve the performance of our model in making predictions by selecting our predictor models from our data set with AIC. Since it is a scientific method of model selection, we explored it as an option which would generate an optimized model that would achieve the better performance given the limitations inherent in our data.

```{r, results='asis'}
conf_mat <- confusionMatrix(as.factor(ifelse(fitted(baseline_model) > 0.5, "1","0")), as.factor(babies$gestation),positive="1")
xtable(conf_mat$table)
conf_mat$overall["Accuracy"]
conf_mat$byClass[c("Sensitivity","Specificity")]
```

```{r, results='asis', message=FALSE}
roc(babies$gestation,fitted(baseline_model),plot=T,print.thres="best",legacy.axes=T, print.auc =T,col="red3")
```

We ultimately carried out step wise model selection with AIC because when we iterated with BIC, it selected a model with mother's height as the only predictor variable without controlling for effects. In order to have answers for the inferential questions, we used step wise model selection with AIC which generated the following model. It worthy to note that interaction between mothers pre-pregnancy weight and the smoking habits of mothers was dropped by the stepwise model selection process.

```{r, results='asis', message=FALSE}
n <- nrow(babies)
null_model <- glm(gestation ~ 1, family=binomial(link=logit), data=babies)
full_model <- glm(gestation ~ mpregwt_c + mage_c + mht_c + smoke + mrace + med + parity + inc + mpregwt_c:smoke + mpregwt_c:mrace + mpregwt_c:med + mht_c*(smoke + mrace + med + parity + inc), family=binomial(link=logit), data=babies)
stepwise <- step(glm(gestation~1, data=babies, family=binomial), scope=formula(full_model),direction="both", trace=0)
#stepwise$call
xtable(stepwise)
```


There was no randomness in the points of the average residuals and predicted probabilities plot, and all but one observation were located in the 95% confidence interval. The same can be said for the plot of average residuals against mother pre-pregnancy weight.

```{r, results='asis'}
step_model <- glm(gestation ~ mpregwt_c + mrace + med + smoke, family=binomial(link=logit), data=babies)
rawresid2 <- residuals(step_model,"resp")
binnedplot(x=fitted(step_model), y=rawresid2, xlab="Pred. probabilities", col.int = "red4", ylab="Avg. residuals", main="Binned Residual Plot of Stepwise Model", col.pts="navy")
```

```{r, results='asis'}
binnedplot(x=babies$mpregwt_c, y=rawresid2, xlab="Mothers Pre-pregnancy Weight Centered", col.int = "red4", ylab="Avg. residuals", main="Binned Residual Plot of Mothers Pre-pregnancy Weight", col.pts="navy")
```

We validated our baseline model initially with a threshold probability of 0.5. We plotted ROC curve to visualize the accuracy of our data. We optimized for the best threshold and we had a threshold probability of 0.22, which raised the sensitivity of the  baseline model from 0.02 to 0.47 and decreased specificity from 0.99 to 0.76. And the AUC was 0.657.

```{r, results='asis'}
conf_mat1 <- confusionMatrix(as.factor(ifelse(fitted(step_model) > 0.5, "1","0")), as.factor(babies$gestation),positive="1")
xtable(conf_mat1$table)
conf_mat1$overall["Accuracy"]
conf_mat1$byClass[c("Sensitivity","Specificity")]
```

```{r, results='asis', message=FALSE}
invisible(roc(babies$gestation,fitted(step_model),plot=T,print.thres=c(0.22),legacy.axes=T, print.auc =T,col="green3", main="ROC Curve for Final Model"))
```

There was no significant difference between the accuracy, sensitivity, specificity and AUC of baseline model and the model selected by the step wise model selection with AIC. Thus our final model had accuracy of 0.71, sensitivity of 0.47, specificity of 0.76 and AUC of 0.657. This means that the predictor variables selected from the EDA to build the baseline model were the predictors that could best explain the odds of a mother giving birth to a premature baby or not. 

Before selecting our final model, it is important to note that since our model had only one continuous predictor variable, which is the mothers pre-pregnancy weight, it was not possible to check for multicollinearity. Also, mothers pre-pregnancy values had been centered before carrying out EDA as preemptive measure against multicollinearity.

The final model could be expressed mathematically as: $$y_{i}|x_{i} ~ Bernoulli(\pi_{i}); log(\frac{\pi_{i}}{1-\pi_{i}}) = \beta _{0} + \beta _{1}x_{i1}(mpregwt)+ \beta _{2j}x_{i2}(mrace)+ \beta _{3j}x_{i3}(med)+ \beta _{4j}x_{i4}(smoke)$$
where $\pi_{i}$ is the odds of giving birth to a premature baby


The summary table of the final model is as follows:
```{r, results='asis'}
final_model <- glm(gestation ~ mpregwt_c + mrace + med + smoke, family=binomial(link=logit), data=babies)
print(xtable(final_model), floating=TRUE, latex.environments = "center")
```


The only selected predictor variable which had a statistical significance on the odds of a mother giving birth to premature babies is the pre-pregnancy weight of mothers. The change in deviance was 45.92.



### Findings

We inferred from our final model that, for mothers who had the same pre-pregnancy weight, had less than 8th grade education and belonged to the white race, the odds of giving birth to premature babies is 34% higher for mothers who smoke compared to mothers who do not smoke.

After computing"two-sided" confidence intervals for our "smoke" predictor variable. Accounting for all other predictors, we are 95% confident that the odds ratio of pre-term births for mothers who smoke lies between 7% less and 92% more than the odds ratio for mothers who do not smoke. 

```{r, results='asis', message=FALSE}
ci <- confint(final_model)
#stargazer(final_model, type="text", ci=TRUE, no.space = TRUE, single.row = TRUE)
xtable(ci)
```

After carrying out a Chi-squared test between our final model and a copy of the final model with the interaction between smoking habits of mothers and mother's race included, we had a p-value of 0.269. This means that the model with interaction between mother's smoking habits and mothers race is not significantly different from our final model, statistically. Thus, there is no statistically significant evidence that the odds ratio of pre-term births for smokers and non-smokers differ by mother's race.

```{r, results='asis'}
interaction_model <- glm(gestation ~ mpregwt_c + mrace + med + smoke + smoke:mrace, family=binomial(link=logit), data=babies)
anova_table <- anova(final_model, interaction_model, test="Chisq")
xtable(anova_table)
#stargazer(anova_table, type="text", no.space = TRUE, single.row = TRUE)
```

It is important to note that the only continuous predictor variable that had a significant effect on the odds of giving birth to premature babies was mother's pre-pregnancy weight. From our model, keeping all other variables constant, for every one (1) pound increase in mothers pre-pregnancy weight, the odds of giving birth to a premature baby decreases by 1% for mothers who had less than 8th grade education and were white. Another interesting association observed is that the odds of black and Asian mothers giving birth to premature babies is significantly higher compared to the the odds of white mothers giving birth to premature babies, statistically.

## Conclusion

**Limitations**

Since we used the data set that had already been cleaned up, it was not possible to include father's socioeconomic and biometric data. Since babies bio data is partly inherited from the father, by using this data set, we miss out on other predictors that could explain the odds of mothers giving birth to premature babies.

Despite several iterations to generate an optimized model, our final model had an accuracy of 0.71, a sensitivity of 0.47 and specificity of 0.76. Our model with thus be correct, less than half of the time in predicting whether a child will be born prematurely. This limitation can be attributed to the lack of strong associative relationship between our response variable and all the possible predictor variables in the data. Our AUC was also 0.657 which is far cry from desired value within the close neighborhood of 1.

With a p-value of 0.12, maternal smoking behavior did not have a significant effect on the odds of giving birth to a premature baby. This means that even though we are obliged to include it in our model to interpret its effect on the chances of mothers giving birth to preterm babies, in reality, according to the data, it has no significant bearing on the odds of a mother giving birth to a premature baby. Also, the "smoking.csv" data did not have enough observations for reliable accuracy in Chi-squared approximation so it was difficult to accurately determine if the predictor variables were dependent on the response variable.




























